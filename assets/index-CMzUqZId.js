import{_ as H,l as f,R as xe,e as ae}from"./monaco-BOYU588y.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();function Ae(r){return new Worker("/Verse/assets/editor.worker-b0HUMjXM.js",{name:r==null?void 0:r.name})}class Te{constructor(e){this.scopes=[],this.globalGet=e==null?void 0:e.globalGet,this.globalSet=e==null?void 0:e.globalSet}generate(e){return this.scopes=[new Set],e.body.map(t=>this.generateStatement(t)).filter(t=>t!=="").join(`
`)}currentScope(){return this.scopes[this.scopes.length-1]}generateStatement(e){switch(e.type){case"TypeDeclaration":return"";case"InterfaceDeclaration":return"";case"VariableDeclaration":const t=e.constant?"const":"let",s=e;if(this.currentScope().add(s.identifier),s.value.type==="ObjectExpression"&&s.typeAnnotation&&s.typeAnnotation.type==="TypeReference"){const v=s.typeAnnotation.name;return`${t} ${s.identifier} = ${this.generateObjectExpression(s.value,v)};`}return`${t} ${s.identifier} = ${this.generateExpression(s.value)};`;case"FunctionDeclaration":const n=e;this.currentScope().add(n.name);const i=n.async?"async ":"",o=n.params.map(v=>v.name).join(", ");this.scopes.push(new Set);for(const v of n.params)this.currentScope().add(v.name);const l=n.body.map(v=>this.generateStatement(v)).join(`
`);return this.scopes.pop(),`${i}function ${n.name}(${o}) {
${l}
}`;case"ReturnStatement":return e.value?`return ${this.generateExpression(e.value)};`:"return;";case"IfStatement":const h=this.generateExpression(e.condition),p=e.consequent.map(v=>this.generateStatement(v)).join(`
`),d=e.alternate?`else {
${e.alternate.map(v=>this.generateStatement(v)).join(`
`)}
}`:"";return`if (${h}) {
${p}
} ${d}`;case"ForStatement":const m=e,c=m.async?"await ":"",y=this.generateExpression(m.iterable);this.scopes.push(new Set),this.currentScope().add(m.variable);const g=m.body.map(v=>this.generateStatement(v)).join(`
`);return this.scopes.pop(),`for ${c}(const ${m.variable} of ${y}) {
${g}
}`;case"ExpressionStatement":return`${this.generateExpression(e.expression)};`;default:return""}}generateExpression(e){switch(e.type){case"Literal":return typeof e.value=="string"?`"${e.value}"`:String(e.value);case"Identifier":return!this.isDeclared(e.name)&&this.globalGet?`await ${this.globalGet}(${JSON.stringify(e.name)})`:e.name;case"BinaryExpression":return`(${this.generateExpression(e.left)} ${e.operator} ${this.generateExpression(e.right)})`;case"UnaryExpression":return`${e.operator}${this.generateExpression(e.operand)}`;case"CallExpression":const t=e,s=t.arguments.map(c=>this.generateExpression(c)).join(", ");if(t.callee.type==="MemberExpression"){const c=t.callee,y=this.buildPathFromMember(c.object);if(y&&this.globalGet){const g=`${this.globalGet}(${JSON.stringify(y)})`;let v="";return c.computed?typeof c.property=="string"?/^-?\d+$/.test(c.property)?v=`[${c.property}]`:v=`[${JSON.stringify(c.property)}]`:v=`[${this.generateExpression(c.property)}]`:v=`.${c.property}`,`(await ${g})${v}(${s})`}}return`${this.generateExpression(e.callee)}(${s})`;case"MemberExpression":const i=this.buildPathFromMember(e);if(i&&this.globalGet)return`await ${this.globalGet}(${JSON.stringify(i)})`;const o=this.generateExpression(e.object);return e.computed?typeof e.property=="string"?/^-?\d+$/.test(e.property)?`${o}[${e.property}]`:`${o}[${JSON.stringify(e.property)}]`:`${o}[${this.generateExpression(e.property)}]`:`${o}.${e.property}`;case"ArrayExpression":return`[${e.elements.map(c=>this.generateExpression(c)).join(", ")}]`;case"ObjectExpression":const h=e.__inferredTypeName;return this.generateObjectExpression(e,h);case"ConditionalExpression":return`(${this.generateExpression(e.test)} ? ${this.generateExpression(e.consequent)} : ${this.generateExpression(e.alternate)})`;case"ArrowFunction":const p=e.async?"async ":"",d=e.params.join(", ");this.scopes.push(new Set);for(const c of e.params)this.currentScope().add(c);const m=this.generateExpression(e.body);return this.scopes.pop(),`${p}(${d}) => ${m}`;case"AssignmentExpression":if(e.target.type==="Identifier"){const c=e.target.name;if(!this.isDeclared(c)&&this.globalSet)return`await ${this.globalSet}(${JSON.stringify(c)}, ${this.generateExpression(e.value)})`}if(e.target.type==="MemberExpression"){const c=this.buildPathFromMember(e.target);if(c&&this.globalSet)return`await ${this.globalSet}(${JSON.stringify(c)}, ${this.generateExpression(e.value)})`}return`${this.generateExpression(e.target)} = ${this.generateExpression(e.value)}`;case"AwaitExpression":return`await ${this.generateExpression(e.argument)}`;default:return""}}generateObjectExpression(e,t){const s=[],n=e.properties.some(i=>i.key==="_type");t&&!n&&s.push(`_type: ${JSON.stringify(t)}`);for(const i of e.properties)s.push(`${i.key}: ${this.generateExpression(i.value)}`);return`{ ${s.join(", ")} }`}isDeclared(e){return this.scopes.some(t=>t.has(e))}buildPathFromMember(e){if(e.type==="Identifier"){const t=e;return this.isDeclared(t.name)?null:t.name}if(e.type==="MemberExpression"){const t=e,s=this.buildPathFromMember(t.object);if(!s)return null;let n=null;if(t.computed)if(typeof t.property=="string")n=t.property;else if(t.property.type==="Literal"){const i=t.property.value;if(typeof i=="string"||typeof i=="number")n=String(i);else return null}else return null;else n=t.property;return n===null?null:/^-?\d+$/.test(n)?`${s}[${n}]`:`${s}.${n}`}return null}}var a=(r=>(r.NUMBER="NUMBER",r.STRING="STRING",r.TRUE="TRUE",r.FALSE="FALSE",r.NULL="NULL",r.IDENTIFIER="IDENTIFIER",r.LET="LET",r.CONST="CONST",r.IF="IF",r.ELSE="ELSE",r.FOR="FOR",r.IN="IN",r.RETURN="RETURN",r.FN="FN",r.TYPE="TYPE",r.INTERFACE="INTERFACE",r.ASYNC="ASYNC",r.AWAIT="AWAIT",r.PLUS="PLUS",r.MINUS="MINUS",r.STAR="STAR",r.SLASH="SLASH",r.PERCENT="PERCENT",r.EQUALS="EQUALS",r.EQUALS_EQUALS="EQUALS_EQUALS",r.BANG_EQUALS="BANG_EQUALS",r.LESS="LESS",r.LESS_EQUALS="LESS_EQUALS",r.GREATER="GREATER",r.GREATER_EQUALS="GREATER_EQUALS",r.AMPERSAND_AMPERSAND="AMPERSAND_AMPERSAND",r.PIPE_PIPE="PIPE_PIPE",r.BANG="BANG",r.QUESTION="QUESTION",r.LPAREN="LPAREN",r.RPAREN="RPAREN",r.LBRACE="LBRACE",r.RBRACE="RBRACE",r.LBRACKET="LBRACKET",r.RBRACKET="RBRACKET",r.COMMA="COMMA",r.DOT="DOT",r.COLON="COLON",r.RETURN_ARROW="RETURN_ARROW",r.FAT_ARROW="FAT_ARROW",r.PIPE="PIPE",r.EOF="EOF",r))(a||{});class Re{constructor(e){this.pos=0,this.line=1,this.column=1,this.source=e}tokenize(){const e=[];for(;this.pos<this.source.length&&(this.skipWhitespace(),!(this.pos>=this.source.length));){const t=this.nextToken();t&&e.push(t)}return e.push({type:"EOF",value:"",line:this.line,column:this.column}),e}nextToken(){const e=this.pos,t=this.column,s=this.source[e],n={"(":"LPAREN",")":"RPAREN","{":"LBRACE","}":"RBRACE","[":"LBRACKET","]":"RBRACKET",",":"COMMA",".":"DOT",":":"COLON","+":"PLUS","*":"STAR","/":"SLASH","%":"PERCENT","?":"QUESTION"};if(n[s])return this.advance(),{type:n[s],value:s,line:this.line,column:t};if(s==="=")return this.advance(),this.peek()==="="?(this.advance(),{type:"EQUALS_EQUALS",value:"==",line:this.line,column:t}):this.peek()===">"?(this.advance(),{type:"FAT_ARROW",value:"=>",line:this.line,column:t}):{type:"EQUALS",value:"=",line:this.line,column:t};if(s==="!")return this.advance(),this.peek()==="="?(this.advance(),{type:"BANG_EQUALS",value:"!=",line:this.line,column:t}):{type:"BANG",value:"!",line:this.line,column:t};if(s==="<")return this.advance(),this.peek()==="="?(this.advance(),{type:"LESS_EQUALS",value:"<=",line:this.line,column:t}):{type:"LESS",value:"<",line:this.line,column:t};if(s===">")return this.advance(),this.peek()==="="?(this.advance(),{type:"GREATER_EQUALS",value:">=",line:this.line,column:t}):{type:"GREATER",value:">",line:this.line,column:t};if(s==="&"){if(this.advance(),this.peek()==="&")return this.advance(),{type:"AMPERSAND_AMPERSAND",value:"&&",line:this.line,column:t};this.backup()}if(s==="|")return this.advance(),this.peek()==="|"?(this.advance(),{type:"PIPE_PIPE",value:"||",line:this.line,column:t}):{type:"PIPE",value:"|",line:this.line,column:t};if(s==="-")return this.advance(),this.isDigit(this.peek())?this.scanNumber(!0):this.peek()===">"?(this.advance(),{type:"RETURN_ARROW",value:"->",line:this.line,column:t}):{type:"MINUS",value:"-",line:this.line,column:t};if(s==='"'||s==="'")return this.scanString(s);if(this.isDigit(s))return this.scanNumber();if(this.isAlpha(s))return this.scanIdentifier();throw new Error(`Unexpected character '${s}' at line ${this.line}, column ${this.column}`)}scanString(e){const t=this.column;this.advance();let s="";for(;this.pos<this.source.length&&this.source[this.pos]!==e;){if(this.source[this.pos]==="\\"){this.advance();const n=this.source[this.pos];s+=n==="n"?`
`:n==="t"?"	":n}else s+=this.source[this.pos];this.advance()}if(this.pos>=this.source.length)throw new Error(`Unterminated string at line ${this.line}`);return this.advance(),{type:"STRING",value:s,line:this.line,column:t}}scanNumber(e=!1){const t=this.column;let s=e?"-":"";for(;this.isDigit(this.peek());)s+=this.source[this.pos],this.advance();if(this.peek()==="."&&this.isDigit(this.source[this.pos+1]))for(s+=this.source[this.pos],this.advance();this.isDigit(this.peek());)s+=this.source[this.pos],this.advance();return{type:"NUMBER",value:s,line:this.line,column:t}}scanIdentifier(){const e=this.column;let t="";for(;this.isAlphaNumeric(this.peek());)t+=this.source[this.pos],this.advance();return{type:{let:"LET",const:"CONST",if:"IF",else:"ELSE",for:"FOR",in:"IN",return:"RETURN",fn:"FN",type:"TYPE",interface:"INTERFACE",true:"TRUE",false:"FALSE",null:"NULL",async:"ASYNC",await:"AWAIT"}[t]||"IDENTIFIER",value:t,line:this.line,column:e}}skipWhitespace(){for(;this.pos<this.source.length;){const e=this.source[this.pos];if(e===" "||e==="	"||e==="\r")this.advance();else if(e===`
`)this.advance(),this.line++,this.column=1;else if(e==="/"&&this.source[this.pos+1]==="/")for(;this.pos<this.source.length&&this.source[this.pos]!==`
`;)this.advance();else break}}peek(){return this.source[this.pos]||""}backup(){this.pos--,this.column--}advance(){this.pos++,this.column++}isDigit(e){return e>="0"&&e<="9"}isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e==="_"}isAlphaNumeric(e){return this.isAlpha(e)||this.isDigit(e)}}class ke{constructor(e){this.pos=0,this.tokens=e}parse(){const e=[];for(;!this.isAtEnd();)e.push(this.statement());return{type:"Program",body:e}}statement(){if(this.match(a.TYPE))return this.typeDeclaration();if(this.match(a.INTERFACE))return this.interfaceDeclaration();if(this.match(a.LET,a.CONST))return this.variableDeclaration();if(this.match(a.ASYNC)){if(this.match(a.FN))return this.functionDeclaration(!0);throw new Error('Expected "fn" after "async"')}return this.match(a.FN)?this.functionDeclaration(!1):this.match(a.RETURN)?this.returnStatement():this.match(a.IF)?this.ifStatement():this.match(a.FOR)?this.forStatement():this.expressionStatement()}typeDeclaration(){const e=this.consume(a.IDENTIFIER,"Expected type name").value;this.consume(a.EQUALS,"Expected = after type name");const t=this.parseTypeAnnotation();return{type:"TypeDeclaration",name:e,typeAnnotation:t}}interfaceDeclaration(){const e=this.consume(a.IDENTIFIER,"Expected interface name").value;this.consume(a.LBRACE,"Expected { after interface name");const t=[];for(;!this.check(a.RBRACE)&&!this.isAtEnd();){const s=this.consume(a.IDENTIFIER,"Expected property name").value;this.consume(a.COLON,"Expected : after property name");const n=this.parseTypeAnnotation();t.push({key:s,typeAnnotation:n}),this.match(a.COMMA)}return this.consume(a.RBRACE,"Expected } after interface body"),{type:"InterfaceDeclaration",name:e,properties:t}}variableDeclaration(){const e=this.previous().type===a.CONST,t=this.consume(a.IDENTIFIER,"Expected variable name").value;let s;this.match(a.COLON)&&(s=this.parseTypeAnnotation()),this.consume(a.EQUALS,"Expected = after variable name");const n=this.expression();return{type:"VariableDeclaration",identifier:t,value:n,constant:e,typeAnnotation:s}}functionDeclaration(e){const t=this.consume(a.IDENTIFIER,"Expected function name").value;this.consume(a.LPAREN,"Expected ( after function name");const s=[];if(!this.check(a.RPAREN))do{const o=this.consume(a.IDENTIFIER,"Expected parameter name").value;let l;this.match(a.COLON)&&(l=this.parseTypeAnnotation()),s.push({name:o,typeAnnotation:l})}while(this.match(a.COMMA));this.consume(a.RPAREN,"Expected ) after parameters");let n;this.match(a.RETURN_ARROW)&&(n=this.parseTypeAnnotation()),this.consume(a.LBRACE,"Expected { before function body");const i=[];for(;!this.check(a.RBRACE)&&!this.isAtEnd();)i.push(this.statement());return this.consume(a.RBRACE,"Expected } after function body"),{type:"FunctionDeclaration",name:t,params:s,returnTypeAnnotation:n,body:i,async:e}}returnStatement(){return{type:"ReturnStatement",value:this.check(a.RBRACE)||this.isAtEnd()?null:this.expression()}}ifStatement(){const e=this.expression();this.consume(a.LBRACE,"Expected { after if condition");const t=[];for(;!this.check(a.RBRACE)&&!this.isAtEnd();)t.push(this.statement());this.consume(a.RBRACE,"Expected } after if body");let s=null;if(this.match(a.ELSE)){for(this.consume(a.LBRACE,"Expected { after else"),s=[];!this.check(a.RBRACE)&&!this.isAtEnd();)s.push(this.statement());this.consume(a.RBRACE,"Expected } after else body")}return{type:"IfStatement",condition:e,consequent:t,alternate:s}}forStatement(){const e=this.match(a.AWAIT),t=this.consume(a.IDENTIFIER,"Expected variable name in for loop").value;this.consume(a.IN,'Expected "in" in for loop');const s=this.expression();this.consume(a.LBRACE,"Expected { after for header");const n=[];for(;!this.check(a.RBRACE)&&!this.isAtEnd();)n.push(this.statement());return this.consume(a.RBRACE,"Expected } after for body"),{type:"ForStatement",variable:t,iterable:s,body:n,async:e}}expressionStatement(){return{type:"ExpressionStatement",expression:this.expression()}}parseTypeAnnotation(){if(this.check(a.IDENTIFIER)&&this.peek().value==="Promise"){this.advance(),this.consume(a.LESS,"Expected < after Promise");const t=this.parseTypeAnnotation();return this.consume(a.GREATER,"Expected > after Promise type"),{type:"PromiseType",resolveType:t}}const e=[];for(e.push(this.parseSingleType());this.match(a.PIPE);)e.push(this.parseSingleType());return e.length===1?e[0]:{type:"UnionType",types:e}}parseSingleType(){const e=this.parseBaseType();return this.match(a.LBRACKET)?(this.consume(a.RBRACKET,"Expected ] after ["),{type:"ArrayType",elementType:e}):e}parseBaseType(){const e=this.peek();if(e.type===a.IDENTIFIER){const t=e.value;if(t==="number"||t==="string"||t==="boolean"||t==="null")return this.advance(),{type:"PrimitiveType",name:t}}if(e.type===a.NULL)return this.advance(),{type:"PrimitiveType",name:e.value};if(this.match(a.LBRACE)){const t=[];for(;!this.check(a.RBRACE)&&!this.isAtEnd();){const s=this.consume(a.IDENTIFIER,"Expected property name").value;this.consume(a.COLON,"Expected : after property name");const n=this.parseTypeAnnotation();t.push({key:s,valueType:n}),this.match(a.COMMA)}return this.consume(a.RBRACE,"Expected }"),{type:"ObjectType",properties:t}}if(this.check(a.IDENTIFIER))return{type:"TypeReference",name:this.advance().value};throw new Error(`Expected type annotation at line ${e.line}`)}expression(){return this.assignment()}assignment(){const e=this.conditional();if(this.match(a.EQUALS)){const t=this.assignment();return{type:"AssignmentExpression",target:e,value:t}}return e}conditional(){const e=this.logicalOr();if(this.match(a.QUESTION)){const t=this.expression();this.consume(a.COLON,"Expected : in ternary expression");const s=this.expression();return{type:"ConditionalExpression",test:e,consequent:t,alternate:s}}return e}logicalOr(){let e=this.logicalAnd();for(;this.match(a.PIPE_PIPE);){const t=this.previous().value,s=this.logicalAnd();e={type:"BinaryExpression",operator:t,left:e,right:s}}return e}logicalAnd(){let e=this.equality();for(;this.match(a.AMPERSAND_AMPERSAND);){const t=this.previous().value,s=this.equality();e={type:"BinaryExpression",operator:t,left:e,right:s}}return e}equality(){let e=this.comparison();for(;this.match(a.EQUALS_EQUALS,a.BANG_EQUALS);){const t=this.previous().value,s=this.comparison();e={type:"BinaryExpression",operator:t,left:e,right:s}}return e}comparison(){let e=this.additive();for(;this.match(a.LESS,a.LESS_EQUALS,a.GREATER,a.GREATER_EQUALS);){const t=this.previous().value,s=this.additive();e={type:"BinaryExpression",operator:t,left:e,right:s}}return e}additive(){let e=this.multiplicative();for(;this.match(a.PLUS,a.MINUS);){const t=this.previous().value,s=this.multiplicative();e={type:"BinaryExpression",operator:t,left:e,right:s}}return e}multiplicative(){let e=this.unary();for(;this.match(a.STAR,a.SLASH,a.PERCENT);){const t=this.previous().value,s=this.unary();e={type:"BinaryExpression",operator:t,left:e,right:s}}return e}unary(){if(this.match(a.BANG,a.MINUS)){const e=this.previous().value,t=this.unary();return{type:"UnaryExpression",operator:e,operand:t}}return this.match(a.AWAIT)?{type:"AwaitExpression",argument:this.unary()}:this.call()}call(){let e=this.member();for(;this.match(a.LPAREN);){const t=[];if(!this.check(a.RPAREN))do t.push(this.expression());while(this.match(a.COMMA));this.consume(a.RPAREN,"Expected ) after arguments"),e={type:"CallExpression",callee:e,arguments:t}}return e}member(){let e=this.primary();for(;;)if(this.match(a.DOT)){const t=this.consume(a.IDENTIFIER,"Expected property name").value;e={type:"MemberExpression",object:e,property:t,computed:!1}}else if(this.match(a.LBRACKET)){const t=this.expression();this.consume(a.RBRACKET,"Expected ] after index"),t.type==="Literal"?e={type:"MemberExpression",object:e,property:String(t.value),computed:!0}:e={type:"MemberExpression",object:e,property:t,computed:!0}}else break;return e}primary(){if(this.match(a.TRUE))return{type:"Literal",value:!0};if(this.match(a.FALSE))return{type:"Literal",value:!1};if(this.match(a.NULL))return{type:"Literal",value:null};if(this.match(a.NUMBER))return{type:"Literal",value:parseFloat(this.previous().value)};if(this.match(a.STRING))return{type:"Literal",value:this.previous().value};if(this.match(a.ASYNC)){if(this.check(a.IDENTIFIER)){const e=this.advance().value;if(this.match(a.FAT_ARROW)){const t=this.expression();return{type:"ArrowFunction",params:[e],body:t,async:!0}}throw new Error("Expected => after async parameter")}if(this.match(a.LPAREN)){const e=[];if(!this.check(a.RPAREN))do e.push(this.consume(a.IDENTIFIER,"Expected parameter").value);while(this.match(a.COMMA));this.consume(a.RPAREN,"Expected ) after parameters"),this.consume(a.FAT_ARROW,"Expected => after async parameters");const t=this.expression();return{type:"ArrowFunction",params:e,body:t,async:!0}}throw new Error("Expected identifier or ( after async")}if(this.match(a.IDENTIFIER)){const e=this.previous().value;if(this.match(a.FAT_ARROW)){const t=this.expression();return{type:"ArrowFunction",params:[e],body:t,async:!1}}return{type:"Identifier",name:e}}if(this.match(a.LPAREN)){const e=this.pos,t=[];if(!this.check(a.RPAREN)&&this.check(a.IDENTIFIER))for(t.push(this.advance().value);this.match(a.COMMA);)t.push(this.consume(a.IDENTIFIER,"Expected parameter").value);if(this.match(a.RPAREN)&&this.match(a.FAT_ARROW)){const n=this.expression();return{type:"ArrowFunction",params:t,body:n,async:!1}}this.pos=e;const s=this.expression();return this.consume(a.RPAREN,"Expected ) after expression"),s}if(this.match(a.LBRACKET)){const e=[];if(!this.check(a.RBRACKET))do e.push(this.expression());while(this.match(a.COMMA));return this.consume(a.RBRACKET,"Expected ] after array elements"),{type:"ArrayExpression",elements:e}}if(this.match(a.LBRACE)){const e=[];if(!this.check(a.RBRACE))do{const t=this.consume(a.IDENTIFIER,"Expected property key").value;this.consume(a.COLON,"Expected : after property key");const s=this.expression();e.push({key:t,value:s})}while(this.match(a.COMMA));return this.consume(a.RBRACE,"Expected } after object properties"),{type:"ObjectExpression",properties:e}}throw new Error(`Unexpected token: ${this.peek().type} at line ${this.peek().line}`)}match(...e){for(const t of e)if(this.check(t))return this.advance(),!0;return!1}check(e){return this.isAtEnd()?!1:this.peek().type===e}advance(){return this.isAtEnd()||this.pos++,this.previous()}isAtEnd(){return this.peek().type===a.EOF}peek(){return this.tokens[this.pos]}previous(){return this.tokens[this.pos-1]}consume(e,t){if(this.check(e))return this.advance();throw new Error(`${t} at line ${this.peek().line}, got ${this.peek().type}`)}}const u={number:{kind:"primitive",name:"number"},string:{kind:"primitive",name:"string"},boolean:{kind:"primitive",name:"boolean"},null:{kind:"primitive",name:"null"},unknown:{kind:"unknown"}};class Ce{constructor(e,t){if(this.symbolTable=new Map,this.customTypes=new Map,this.currentFunctionIsAsync=!1,this.allowTopLevelAwait=!0,e)for(const[s,n]of Object.entries(e))this.symbolTable.set(s,n);t&&typeof t.allowTopLevelAwait=="boolean"&&(this.allowTopLevelAwait=t.allowTopLevelAwait)}registerType(e,t){this.customTypes.set(e,t)}registerFunction(e,t,s,n=!1){const i={kind:"function",parameters:t,returnType:s,async:n};this.symbolTable.set(e,i)}check(e){let t=u.unknown;const s=this.currentFunctionIsAsync;this.currentFunctionIsAsync=this.allowTopLevelAwait;try{for(const n of e.body)t=this.checkStatement(n)}finally{this.currentFunctionIsAsync=s}return t}inferReturnType(e){this.check(e);const t=[],s=n=>{for(const i of n)i.type==="ReturnStatement"?i.value&&t.push(this.inferExpression(i.value)):i.type==="IfStatement"?(s(i.consequent),i.alternate&&s(i.alternate)):i.type==="ForStatement"&&s(i.body)};return s(e.body),t.length===0?u.null:t.length===1?t[0]:{kind:"union",types:t}}checkStatement(e){switch(e.type){case"TypeDeclaration":return this.checkTypeDeclaration(e);case"InterfaceDeclaration":return this.checkInterfaceDeclaration(e);case"VariableDeclaration":return this.checkVariableDeclaration(e);case"FunctionDeclaration":return this.checkFunctionDeclaration(e);case"ReturnStatement":return e.value?this.inferExpression(e.value):u.unknown;case"IfStatement":return this.checkIfStatement(e);case"ForStatement":return this.checkForStatement(e);case"ExpressionStatement":return this.inferExpression(e.expression);default:return u.unknown}}checkTypeDeclaration(e){const t=this.annotationToType(e.typeAnnotation);return this.customTypes.set(e.name,t),t}checkInterfaceDeclaration(e){const t={};for(const n of e.properties)t[n.key]=this.annotationToType(n.typeAnnotation);const s={kind:"object",name:e.name,properties:t};return this.customTypes.set(e.name,s),s}annotationToType(e){switch(e.type){case"PrimitiveType":return u[e.name];case"ArrayType":return{kind:"array",elementType:this.annotationToType(e.elementType)};case"ObjectType":const t={};for(const s of e.properties)t[s.key]=this.annotationToType(s.valueType);return{kind:"object",properties:t};case"UnionType":return{kind:"union",types:e.types.map(s=>this.annotationToType(s))};case"TypeReference":return this.customTypes.get(e.name)||u.unknown;case"PromiseType":return{kind:"promise",resolveType:this.annotationToType(e.resolveType)};default:return u.unknown}}checkVariableDeclaration(e){const t=this.inferExpression(e.value);if(e.typeAnnotation){const s=this.annotationToType(e.typeAnnotation);if(!this.isAssignable(t,s))throw new TypeError(`Cannot assign ${this.typeToString(t)} to ${this.typeToString(s)}`);return this.symbolTable.set(e.identifier,s),s}return this.symbolTable.set(e.identifier,t),t}checkFunctionDeclaration(e){const t=new Map(this.symbolTable),s=this.currentFunctionIsAsync;this.currentFunctionIsAsync=e.async;const n=[];for(const p of e.params){const d=p.typeAnnotation?this.annotationToType(p.typeAnnotation):u.unknown;this.symbolTable.set(p.name,d),n.push(d)}const i=[];for(const p of e.body)p.type==="ReturnStatement"&&p.value&&i.push(this.inferExpression(p.value));const o=i.length>0?i.length===1?i[0]:{kind:"union",types:i}:u.unknown;let l=e.async&&o.kind!=="promise"?{kind:"promise",resolveType:o}:o;if(e.returnTypeAnnotation){const p=this.annotationToType(e.returnTypeAnnotation);if(!this.isAssignable(l,p))throw new TypeError(`Function ${e.name} returns ${this.typeToString(l)} but declared ${this.typeToString(p)}`);l=p}this.symbolTable=t,this.currentFunctionIsAsync=s;const h={kind:"function",parameters:n,returnType:l,async:e.async};return this.symbolTable.set(e.name,h),h}isAssignable(e,t){var s;if(e.kind==="union")return(e.types||[]).every(i=>this.isAssignable(i,t));if(this.typesEqual(e,t)||e.kind==="unknown"||t.kind==="unknown")return!0;if(t.kind==="union")return(t.types||[]).some(i=>this.isAssignable(e,i));if(e.kind==="array"&&t.kind==="array")return this.isAssignable(e.elementType||u.unknown,t.elementType||u.unknown);if(e.kind==="promise"&&t.kind==="promise")return this.isAssignable(e.resolveType||u.unknown,t.resolveType||u.unknown);if(t.kind==="object"&&e.kind==="object"){for(const[n,i]of Object.entries(t.properties||{})){const o=(s=e.properties)==null?void 0:s[n];if(!o||!this.isAssignable(o,i))return!1}return!0}return!1}checkIfStatement(e){this.inferExpression(e.condition);const t=[];for(const s of e.consequent)t.push(this.checkStatement(s));if(e.alternate)for(const s of e.alternate)t.push(this.checkStatement(s));return t.length>0?t[t.length-1]:u.unknown}checkForStatement(e){var o,l;const t=new Map(this.symbolTable),s=this.inferExpression(e.iterable);let n=u.unknown;if(e.async&&s.kind==="promise"&&((o=s.resolveType)==null?void 0:o.kind)==="array"){if(!this.currentFunctionIsAsync)throw new TypeError("await can only be used in async functions");n=((l=s.resolveType)==null?void 0:l.elementType)||u.unknown}else if(s.kind==="array"&&s.elementType)n=s.elementType;else if(e.async)throw new TypeError("for await...of requires an async iterable (Promise<T[]>)");this.symbolTable.set(e.variable,n);let i=u.unknown;for(const h of e.body)i=this.checkStatement(h);return this.symbolTable=t,i}inferExpression(e){switch(e.type){case"Literal":return this.inferLiteral(e);case"Identifier":return this.inferIdentifier(e);case"BinaryExpression":return this.inferBinaryExpression(e);case"UnaryExpression":return this.inferUnaryExpression(e);case"CallExpression":return this.inferCallExpression(e);case"MemberExpression":return this.inferMemberExpression(e);case"ArrayExpression":return this.inferArrayExpression(e);case"ObjectExpression":return this.inferObjectExpression(e);case"ConditionalExpression":return this.inferConditionalExpression(e);case"ArrowFunction":return this.inferArrowFunction(e);case"AwaitExpression":return this.inferAwaitExpression(e);case"AssignmentExpression":const t=this.inferExpression(e.value);return e.target.type==="Identifier"&&this.symbolTable.set(e.target.name,t),t;default:return u.unknown}}inferAwaitExpression(e){if(!this.currentFunctionIsAsync)throw new TypeError("await can only be used in async functions");const t=this.inferExpression(e.argument);return t.kind==="promise"&&t.resolveType?t.resolveType:t}inferLiteral(e){return typeof e.value=="number"?u.number:typeof e.value=="string"?u.string:typeof e.value=="boolean"?u.boolean:e.value===null?u.null:u.unknown}inferIdentifier(e){let t=this.symbolTable.get(e.name);return(!t||t.kind==="unknown")&&(t=this.customTypes.get(e.name)),t||(t=u.unknown),t}inferBinaryExpression(e){const t=this.inferExpression(e.left),s=this.inferExpression(e.right);return["+","-","*","/","%"].includes(e.operator)?e.operator==="+"&&(t.kind==="primitive"&&t.name==="string"||s.kind==="primitive"&&s.name==="string")?u.string:u.number:["==","!=","<","<=",">",">="].includes(e.operator)||["&&","||"].includes(e.operator)?u.boolean:u.unknown}inferUnaryExpression(e){const t=this.inferExpression(e.operand);return e.operator==="!"?u.boolean:e.operator==="-"?u.number:t}inferCallExpression(e){const t=this.inferExpression(e.callee);if(e.callee.type==="MemberExpression"){const s=this.inferExpression(e.callee.object);let n=null;if(typeof e.callee.property=="string"?n=e.callee.property:e.callee.property.type==="Literal"&&typeof e.callee.property.value=="string"&&(n=e.callee.property.value),n&&s.kind==="array"&&s.elementType){if(["filter","map","slice","concat"].includes(n))return n==="map"&&e.arguments.length>0,s;if(["find","at"].includes(n))return s.elementType;if(["length","findIndex","indexOf"].includes(n))return u.number;if(["some","every","includes"].includes(n))return u.boolean}}return t.kind==="function"&&t.returnType?t.returnType:u.unknown}inferMemberExpression(e){const t=this.inferExpression(e.object);if(!e.computed)return t.kind==="object"&&t.properties?t.properties[e.property]||u.unknown:t.kind==="array"&&e.property==="length"?u.number:u.unknown;let s=null;if(typeof e.property=="string")/^-?\d+$/.test(e.property)?s=Number(e.property):s=e.property;else if(e.property.type==="Literal"){const n=e.property.value;(typeof n=="number"||typeof n=="string")&&(s=n)}if(s!==null&&typeof s=="string"){if(t.kind==="object"&&t.properties)return t.properties[s]||u.unknown;if(t.kind==="array"&&s==="length")return u.number}return s!==null&&typeof s=="number"&&t.kind==="array"&&t.elementType?t.elementType:u.unknown}inferArrayExpression(e){return e.elements.length===0?{kind:"array",elementType:u.unknown}:{kind:"array",elementType:this.inferExpression(e.elements[0])}}inferObjectExpression(e){const t={};for(const s of e.properties)t[s.key]=this.inferExpression(s.value);return{kind:"object",properties:t}}inferConditionalExpression(e){const t=this.inferExpression(e.consequent),s=this.inferExpression(e.alternate);return this.typesEqual(t,s)?t:{kind:"union",types:[t,s]}}inferArrowFunction(e){const t=new Map(this.symbolTable),s=this.currentFunctionIsAsync;this.currentFunctionIsAsync=e.async;for(const i of e.params)this.symbolTable.set(i,u.unknown);let n=this.inferExpression(e.body);return e.async&&n.kind!=="promise"&&(n={kind:"promise",resolveType:n}),this.symbolTable=t,this.currentFunctionIsAsync=s,{kind:"function",parameters:e.params.map(()=>u.unknown),returnType:n,async:e.async}}typesEqual(e,t){return e.kind!==t.kind?!1:e.kind==="primitive"&&t.kind==="primitive"?e.name===t.name:e.kind==="array"&&t.kind==="array"?this.typesEqual(e.elementType||u.unknown,t.elementType||u.unknown):e.kind==="promise"&&t.kind==="promise"?this.typesEqual(e.resolveType||u.unknown,t.resolveType||u.unknown):!1}typeToString(e){switch(e.kind){case"primitive":return e.name||"unknown";case"array":return`${this.typeToString(e.elementType||u.unknown)}[]`;case"promise":return`Promise<${this.typeToString(e.resolveType||u.unknown)}>`;case"object":return e.name?e.name:`{ ${Object.entries(e.properties||{}).map(([i,o])=>`${i}: ${this.typeToString(o)}`).join(", ")} }`;case"function":const s=(e.parameters||[]).map(i=>this.typeToString(i)).join(", ");return`${e.async?"async ":""}(${s}) => ${this.typeToString(e.returnType||u.unknown)}`;case"union":return(e.types||[]).map(i=>this.typeToString(i)).join(" | ");case"unknown":return"unknown";default:return"unknown"}}}class b{constructor(e,t){this.typeChecker=new Ce(e),this.codeGenOptions=t}registerType(e,t){this.typeChecker.registerType(e,t)}registerFunction(e,t,s,n=!1){this.typeChecker.registerFunction(e,t,s,n)}compile(e){try{const s=new Re(e).tokenize(),i=new ke(s).parse(),o=this.typeChecker.inferReturnType(i),l=this.typeChecker.typeToString(o),h=m=>{if(!m||typeof m!="object")return;const c=m;if(c.type==="ObjectExpression")try{const y=this.typeChecker.inferExpression(c);y&&y.kind==="object"&&y.name&&(c.__inferredTypeName=y.name)}catch{}for(const y of Object.keys(m)){const g=m[y];Array.isArray(g)?g.forEach(v=>h(v)):g&&typeof g=="object"&&h(g)}};h(i);const d=new Te(this.codeGenOptions).generate(i);return{success:!0,returnType:l,code:d}}catch(t){return{success:!1,error:t instanceof Error?t.message:String(t)}}}static createObjectType(e,t){return{kind:"object",name:e,properties:t}}static createArrayType(e){return{kind:"array",elementType:e}}}var k={JS_EVAL_TYPE_GLOBAL:0,JS_EVAL_TYPE_MODULE:1,JS_EVAL_FLAG_STRICT:8,JS_EVAL_FLAG_STRIP:16,JS_EVAL_FLAG_COMPILE_ONLY:32,JS_EVAL_FLAG_BACKTRACE_BARRIER:64},ee={BaseObjects:1,Date:2,Eval:4,StringNormalize:8,RegExp:16,RegExpCompiler:32,JSON:64,Proxy:128,MapSet:256,TypedArrays:512,Promise:1024,BigInt:2048,BigFloat:4096,BigDecimal:8192,OperatorOverloading:16384,BignumExt:32768},D={Pending:0,Fulfilled:1,Rejected:2},C={JS_GPN_STRING_MASK:1,JS_GPN_SYMBOL_MASK:2,JS_GPN_PRIVATE_MASK:4,JS_GPN_ENUM_ONLY:16,QTS_GPN_NUMBER_MASK:64,QTS_STANDARD_COMPLIANT_NUMBER:128},N={IsStrictlyEqual:0,IsSameValue:1,IsSameValueZero:2},Pe=Object.defineProperty,Ie=(r,e)=>{for(var t in e)Pe(r,t,{get:e[t],enumerable:!0})};function I(...r){}var _e={};Ie(_e,{QuickJSAsyncifyError:()=>ue,QuickJSAsyncifySuspended:()=>ce,QuickJSEmptyGetOwnPropertyNames:()=>me,QuickJSEmscriptenModuleError:()=>V,QuickJSMemoryLeakDetected:()=>Le,QuickJSNotImplemented:()=>le,QuickJSPromisePending:()=>pe,QuickJSUnknownIntrinsic:()=>he,QuickJSUnwrapError:()=>U,QuickJSUseAfterFree:()=>j,QuickJSWrongOwner:()=>oe});var U=class extends Error{constructor(r,e){let t=typeof r=="object"&&r&&"message"in r?String(r.message):String(r);super(t),this.cause=r,this.context=e,this.name="QuickJSUnwrapError"}},oe=class extends Error{constructor(){super(...arguments),this.name="QuickJSWrongOwner"}},j=class extends Error{constructor(){super(...arguments),this.name="QuickJSUseAfterFree"}},le=class extends Error{constructor(){super(...arguments),this.name="QuickJSNotImplemented"}},ue=class extends Error{constructor(){super(...arguments),this.name="QuickJSAsyncifyError"}},ce=class extends Error{constructor(){super(...arguments),this.name="QuickJSAsyncifySuspended"}},Le=class extends Error{constructor(){super(...arguments),this.name="QuickJSMemoryLeakDetected"}},V=class extends Error{constructor(){super(...arguments),this.name="QuickJSEmscriptenModuleError"}},he=class extends TypeError{constructor(){super(...arguments),this.name="QuickJSUnknownIntrinsic"}},pe=class extends Error{constructor(){super(...arguments),this.name="QuickJSPromisePending"}},me=class extends Error{constructor(){super(...arguments),this.name="QuickJSEmptyGetOwnPropertyNames"}};function*de(r){return yield r}function Ne(r){return de(W(r))}var K=de;K.of=Ne;function te(r,e){return(...t)=>{let s=e.call(r,K,...t);return W(s)}}function Me(r,e){let t=e.call(r,K);return W(t)}function W(r){function e(t){return t.done?t.value:t.value instanceof Promise?t.value.then(s=>e(r.next(s)),s=>e(r.throw(s))):e(r.next(t.value))}return e(r.next())}var T=class{[Symbol.dispose](){return this.dispose()}},G=Symbol.dispose??Symbol.for("Symbol.dispose"),re=T.prototype;re[G]||(re[G]=function(){return this.dispose()});var E=class fe extends T{constructor(e,t,s,n){super(),this._value=e,this.copier=t,this.disposer=s,this._owner=n,this._alive=!0,this._constructorStack=void 0}get alive(){return this._alive}get value(){return this.assertAlive(),this._value}get owner(){return this._owner}get dupable(){return!!this.copier}dup(){if(this.assertAlive(),!this.copier)throw new Error("Non-dupable lifetime");return new fe(this.copier(this._value),this.copier,this.disposer,this._owner)}consume(e){this.assertAlive();let t=e(this);return this.dispose(),t}map(e){return this.assertAlive(),e(this)}tap(e){return e(this),this}dispose(){this.assertAlive(),this.disposer&&this.disposer(this._value),this._alive=!1}assertAlive(){if(!this.alive)throw this._constructorStack?new j(`Lifetime not alive
${this._constructorStack}
Lifetime used`):new j("Lifetime not alive")}},R=class extends E{constructor(r,e){super(r,void 0,void 0,e)}get dupable(){return!0}dup(){return this}dispose(){}},se=class extends E{constructor(r,e,t,s){super(r,e,t,s)}dispose(){this._alive=!1}};function J(r,e){let t;try{r.dispose()}catch(s){t=s}if(e&&t)throw Object.assign(e,{message:`${e.message}
 Then, failed to dispose scope: ${t.message}`,disposeError:t}),e;if(e||t)throw e||t}var S=class M extends T{constructor(){super(...arguments),this._disposables=new E(new Set),this.manage=e=>(this._disposables.value.add(e),e)}static withScope(e){let t=new M,s;try{return e(t)}catch(n){throw s=n,n}finally{J(t,s)}}static withScopeMaybeAsync(e,t){return Me(void 0,function*(s){let n=new M,i;try{return yield*s.of(t.call(e,s,n))}catch(o){throw i=o,o}finally{J(n,i)}})}static async withScopeAsync(e){let t=new M,s;try{return await e(t)}catch(n){throw s=n,n}finally{J(t,s)}}get alive(){return this._disposables.alive}dispose(){let e=Array.from(this._disposables.value.values()).reverse();for(let t of e)t.alive&&t.dispose();this._disposables.dispose()}};function Oe(r){let e=r?Array.from(r):[];function t(){return e.forEach(n=>n.alive?n.dispose():void 0)}function s(){return e.some(n=>n.alive)}return Object.defineProperty(e,G,{configurable:!0,enumerable:!1,value:t}),Object.defineProperty(e,"dispose",{configurable:!0,enumerable:!1,value:t}),Object.defineProperty(e,"alive",{configurable:!0,enumerable:!1,get:s}),e}function $(r){return!!(r&&(typeof r=="object"||typeof r=="function")&&"alive"in r&&typeof r.alive=="boolean"&&"dispose"in r&&typeof r.dispose=="function")}var q=class ye extends T{static success(e){return new Fe(e)}static fail(e,t){return new $e(e,t)}static is(e){return e instanceof ye}},Fe=class extends q{constructor(r){super(),this.value=r}get alive(){return $(this.value)?this.value.alive:!0}dispose(){$(this.value)&&this.value.dispose()}unwrap(){return this.value}unwrapOr(r){return this.value}},$e=class extends q{constructor(r,e){super(),this.error=r,this.onUnwrap=e}get alive(){return $(this.error)?this.error.alive:!0}dispose(){$(this.error)&&this.error.dispose()}unwrap(){throw this.onUnwrap(this),this.error}unwrapOr(r){return r}},P=q,Qe=class extends T{constructor(r){super(),this.resolve=e=>{this.resolveHandle.alive&&(this.context.unwrapResult(this.context.callFunction(this.resolveHandle,this.context.undefined,e||this.context.undefined)).dispose(),this.disposeResolvers(),this.onSettled())},this.reject=e=>{this.rejectHandle.alive&&(this.context.unwrapResult(this.context.callFunction(this.rejectHandle,this.context.undefined,e||this.context.undefined)).dispose(),this.disposeResolvers(),this.onSettled())},this.dispose=()=>{this.handle.alive&&this.handle.dispose(),this.disposeResolvers()},this.context=r.context,this.owner=r.context.runtime,this.handle=r.promiseHandle,this.settled=new Promise(e=>{this.onSettled=e}),this.resolveHandle=r.resolveHandle,this.rejectHandle=r.rejectHandle}get alive(){return this.handle.alive||this.resolveHandle.alive||this.rejectHandle.alive}disposeResolvers(){this.resolveHandle.alive&&this.resolveHandle.dispose(),this.rejectHandle.alive&&this.rejectHandle.dispose()}},ve=class{constructor(r){this.module=r}toPointerArray(r){let e=new Int32Array(r.map(n=>n.value)),t=e.length*e.BYTES_PER_ELEMENT,s=this.module._malloc(t);return new Uint8Array(this.module.HEAPU8.buffer,s,t).set(new Uint8Array(e.buffer)),new E(s,void 0,n=>this.module._free(n))}newTypedArray(r,e){let t=new r(new Array(e).fill(0)),s=t.length*t.BYTES_PER_ELEMENT,n=this.module._malloc(s),i=new r(this.module.HEAPU8.buffer,n,e);return i.set(t),new E({typedArray:i,ptr:n},void 0,o=>this.module._free(o.ptr))}newMutablePointerArray(r){return this.newTypedArray(Int32Array,r)}newHeapCharPointer(r){let e=this.module.lengthBytesUTF8(r),t=e+1,s=this.module._malloc(t);return this.module.stringToUTF8(r,s,t),new E({ptr:s,strlen:e},void 0,n=>this.module._free(n.ptr))}newHeapBufferPointer(r){let e=r.byteLength,t=this.module._malloc(e);return this.module.HEAPU8.set(r,t),new E({pointer:t,numBytes:e},void 0,s=>this.module._free(s.pointer))}consumeHeapCharPointer(r){let e=this.module.UTF8ToString(r);return this.module._free(r),e}};function Be(r){if(!r)return 0;let e=0;for(let[t,s]of Object.entries(r)){if(!(t in ee))throw new he(t);s&&(e|=ee[t])}return e}function De(r){if(typeof r=="number")return r;if(r===void 0)return 0;let{type:e,strict:t,strip:s,compileOnly:n,backtraceBarrier:i}=r,o=0;return e==="global"&&(o|=k.JS_EVAL_TYPE_GLOBAL),e==="module"&&(o|=k.JS_EVAL_TYPE_MODULE),t&&(o|=k.JS_EVAL_FLAG_STRICT),s&&(o|=k.JS_EVAL_FLAG_STRIP),n&&(o|=k.JS_EVAL_FLAG_COMPILE_ONLY),i&&(o|=k.JS_EVAL_FLAG_BACKTRACE_BARRIER),o}function Je(r){if(typeof r=="number")return r;if(r===void 0)return 0;let{strings:e,symbols:t,quickjsPrivate:s,onlyEnumerable:n,numbers:i,numbersAsStrings:o}=r,l=0;return e&&(l|=C.JS_GPN_STRING_MASK),t&&(l|=C.JS_GPN_SYMBOL_MASK),s&&(l|=C.JS_GPN_PRIVATE_MASK),n&&(l|=C.JS_GPN_ENUM_ONLY),i&&(l|=C.QTS_GPN_NUMBER_MASK),o&&(l|=C.QTS_STANDARD_COMPLIANT_NUMBER),l}function He(...r){let e=[];for(let t of r)t!==void 0&&(e=e.concat(t));return e}var Ue=class extends T{constructor(r,e){super(),this.handle=r,this.context=e,this._isDone=!1,this.owner=e.runtime}[Symbol.iterator](){return this}next(r){if(!this.alive||this._isDone)return{done:!0,value:void 0};let e=this._next??(this._next=this.context.getProp(this.handle,"next"));return this.callIteratorMethod(e,r)}return(r){if(!this.alive)return{done:!0,value:void 0};let e=this.context.getProp(this.handle,"return");if(e===this.context.undefined&&r===void 0)return this.dispose(),{done:!0,value:void 0};let t=this.callIteratorMethod(e,r);return e.dispose(),this.dispose(),t}throw(r){if(!this.alive)return{done:!0,value:void 0};let e=r instanceof E?r:this.context.newError(r),t=this.context.getProp(this.handle,"throw"),s=this.callIteratorMethod(t,r);return e.alive&&e.dispose(),t.dispose(),this.dispose(),s}get alive(){return this.handle.alive}dispose(){var r;this._isDone=!0,this.handle.dispose(),(r=this._next)==null||r.dispose()}callIteratorMethod(r,e){let t=e?this.context.callFunction(r,this.handle,e):this.context.callFunction(r,this.handle);if(t.error)return this.dispose(),{value:t};let s=this.context.getProp(t.value,"done").consume(i=>this.context.dump(i));if(s)return t.value.dispose(),this.dispose(),{done:s,value:void 0};let n=this.context.getProp(t.value,"value");return t.value.dispose(),{value:P.success(n),done:s}}},je=class extends ve{constructor(r){var e;super(r.module),this.scope=new S,this.copyJSValue=t=>this.ffi.QTS_DupValuePointer(this.ctx.value,t),this.freeJSValue=t=>{this.ffi.QTS_FreeValuePointer(this.ctx.value,t)},(e=r.ownedLifetimes)==null||e.forEach(t=>this.scope.manage(t)),this.owner=r.owner,this.module=r.module,this.ffi=r.ffi,this.rt=r.rt,this.ctx=this.scope.manage(r.ctx)}get alive(){return this.scope.alive}dispose(){return this.scope.dispose()}[Symbol.dispose](){return this.dispose()}manage(r){return this.scope.manage(r)}consumeJSCharPointer(r){let e=this.module.UTF8ToString(r);return this.ffi.QTS_FreeCString(this.ctx.value,r),e}heapValueHandle(r){return new E(r,this.copyJSValue,this.freeJSValue,this.owner)}staticHeapValueHandle(r){return this.manage(this.heapValueHandle(r)),new R(r,this.owner)}},Ve=class extends T{constructor(r){super(),this._undefined=void 0,this._null=void 0,this._false=void 0,this._true=void 0,this._global=void 0,this._BigInt=void 0,this._Symbol=void 0,this._SymbolIterator=void 0,this._SymbolAsyncIterator=void 0,this.fnNextId=-32768,this.fnMaps=new Map,this.cToHostCallbacks={callFunction:(e,t,s,n,i)=>{if(e!==this.ctx.value)throw new Error("QuickJSContext instance received C -> JS call with mismatched ctx");let o=this.getFunction(i);if(!o)throw new Error(`QuickJSContext had no callback with id ${i}`);return S.withScopeMaybeAsync(this,function*(l,h){let p=h.manage(new se(t,this.memory.copyJSValue,this.memory.freeJSValue,this.runtime)),d=new Array(s);for(let m=0;m<s;m++){let c=this.ffi.QTS_ArgvGetJSValueConstPointer(n,m);d[m]=h.manage(new se(c,this.memory.copyJSValue,this.memory.freeJSValue,this.runtime))}try{let m=yield*l(o.apply(p,d));if(m){if("error"in m&&m.error)throw this.runtime.debugLog("throw error",m.error),m.error;let c=h.manage(m instanceof E?m:m.value);return this.ffi.QTS_DupValuePointer(this.ctx.value,c.value)}return 0}catch(m){return this.errorToHandle(m).consume(c=>this.ffi.QTS_Throw(this.ctx.value,c.value))}})}},this.runtime=r.runtime,this.module=r.module,this.ffi=r.ffi,this.rt=r.rt,this.ctx=r.ctx,this.memory=new je({...r,owner:this.runtime}),r.callbacks.setContextCallbacks(this.ctx.value,this.cToHostCallbacks),this.dump=this.dump.bind(this),this.getString=this.getString.bind(this),this.getNumber=this.getNumber.bind(this),this.resolvePromise=this.resolvePromise.bind(this),this.uint32Out=this.memory.manage(this.memory.newTypedArray(Uint32Array,1))}get alive(){return this.memory.alive}dispose(){this.memory.dispose()}get undefined(){if(this._undefined)return this._undefined;let r=this.ffi.QTS_GetUndefined();return this._undefined=new R(r)}get null(){if(this._null)return this._null;let r=this.ffi.QTS_GetNull();return this._null=new R(r)}get true(){if(this._true)return this._true;let r=this.ffi.QTS_GetTrue();return this._true=new R(r)}get false(){if(this._false)return this._false;let r=this.ffi.QTS_GetFalse();return this._false=new R(r)}get global(){if(this._global)return this._global;let r=this.ffi.QTS_GetGlobalObject(this.ctx.value);return this._global=this.memory.staticHeapValueHandle(r),this._global}newNumber(r){return this.memory.heapValueHandle(this.ffi.QTS_NewFloat64(this.ctx.value,r))}newString(r){let e=this.memory.newHeapCharPointer(r).consume(t=>this.ffi.QTS_NewString(this.ctx.value,t.value.ptr));return this.memory.heapValueHandle(e)}newUniqueSymbol(r){let e=(typeof r=="symbol"?r.description:r)??"",t=this.memory.newHeapCharPointer(e).consume(s=>this.ffi.QTS_NewSymbol(this.ctx.value,s.value.ptr,0));return this.memory.heapValueHandle(t)}newSymbolFor(r){let e=(typeof r=="symbol"?r.description:r)??"",t=this.memory.newHeapCharPointer(e).consume(s=>this.ffi.QTS_NewSymbol(this.ctx.value,s.value.ptr,1));return this.memory.heapValueHandle(t)}getWellKnownSymbol(r){return this._Symbol??(this._Symbol=this.memory.manage(this.getProp(this.global,"Symbol"))),this.getProp(this._Symbol,r)}newBigInt(r){if(!this._BigInt){let s=this.getProp(this.global,"BigInt");this.memory.manage(s),this._BigInt=new R(s.value,this.runtime)}let e=this._BigInt,t=String(r);return this.newString(t).consume(s=>this.unwrapResult(this.callFunction(e,this.undefined,s)))}newObject(r){r&&this.runtime.assertOwned(r);let e=r?this.ffi.QTS_NewObjectProto(this.ctx.value,r.value):this.ffi.QTS_NewObject(this.ctx.value);return this.memory.heapValueHandle(e)}newArray(){let r=this.ffi.QTS_NewArray(this.ctx.value);return this.memory.heapValueHandle(r)}newArrayBuffer(r){let e=new Uint8Array(r),t=this.memory.newHeapBufferPointer(e),s=this.ffi.QTS_NewArrayBuffer(this.ctx.value,t.value.pointer,e.length);return this.memory.heapValueHandle(s)}newPromise(r){let e=S.withScope(t=>{let s=t.manage(this.memory.newMutablePointerArray(2)),n=this.ffi.QTS_NewPromiseCapability(this.ctx.value,s.value.ptr),i=this.memory.heapValueHandle(n),[o,l]=Array.from(s.value.typedArray).map(h=>this.memory.heapValueHandle(h));return new Qe({context:this,promiseHandle:i,resolveHandle:o,rejectHandle:l})});return r&&typeof r=="function"&&(r=new Promise(r)),r&&Promise.resolve(r).then(e.resolve,t=>t instanceof E?e.reject(t):this.newError(t).consume(e.reject)),e}newFunction(r,e){let t=++this.fnNextId;return this.setFunction(t,e),this.memory.heapValueHandle(this.ffi.QTS_NewFunction(this.ctx.value,t,r))}newError(r){let e=this.memory.heapValueHandle(this.ffi.QTS_NewError(this.ctx.value));return r&&typeof r=="object"?(r.name!==void 0&&this.newString(r.name).consume(t=>this.setProp(e,"name",t)),r.message!==void 0&&this.newString(r.message).consume(t=>this.setProp(e,"message",t))):typeof r=="string"?this.newString(r).consume(t=>this.setProp(e,"message",t)):r!==void 0&&this.newString(String(r)).consume(t=>this.setProp(e,"message",t)),e}typeof(r){return this.runtime.assertOwned(r),this.memory.consumeHeapCharPointer(this.ffi.QTS_Typeof(this.ctx.value,r.value))}getNumber(r){return this.runtime.assertOwned(r),this.ffi.QTS_GetFloat64(this.ctx.value,r.value)}getString(r){return this.runtime.assertOwned(r),this.memory.consumeJSCharPointer(this.ffi.QTS_GetString(this.ctx.value,r.value))}getSymbol(r){this.runtime.assertOwned(r);let e=this.memory.consumeJSCharPointer(this.ffi.QTS_GetSymbolDescriptionOrKey(this.ctx.value,r.value));return this.ffi.QTS_IsGlobalSymbol(this.ctx.value,r.value)?Symbol.for(e):Symbol(e)}getBigInt(r){this.runtime.assertOwned(r);let e=this.getString(r);return BigInt(e)}getArrayBuffer(r){this.runtime.assertOwned(r);let e=this.ffi.QTS_GetArrayBufferLength(this.ctx.value,r.value),t=this.ffi.QTS_GetArrayBuffer(this.ctx.value,r.value);if(!t)throw new Error("Couldn't allocate memory to get ArrayBuffer");return new E(this.module.HEAPU8.subarray(t,t+e),void 0,()=>this.module._free(t))}getPromiseState(r){this.runtime.assertOwned(r);let e=this.ffi.QTS_PromiseState(this.ctx.value,r.value);if(e<0)return{type:"fulfilled",value:r,notAPromise:!0};if(e===D.Pending)return{type:"pending",get error(){return new pe("Cannot unwrap a pending promise")}};let t=this.ffi.QTS_PromiseResult(this.ctx.value,r.value),s=this.memory.heapValueHandle(t);if(e===D.Fulfilled)return{type:"fulfilled",value:s};if(e===D.Rejected)return{type:"rejected",error:s};throw s.dispose(),new Error(`Unknown JSPromiseStateEnum: ${e}`)}resolvePromise(r){this.runtime.assertOwned(r);let e=S.withScope(t=>{let s=t.manage(this.getProp(this.global,"Promise")),n=t.manage(this.getProp(s,"resolve"));return this.callFunction(n,s,r)});return e.error?Promise.resolve(e):new Promise(t=>{S.withScope(s=>{let n=s.manage(this.newFunction("resolve",h=>{t(this.success(h&&h.dup()))})),i=s.manage(this.newFunction("reject",h=>{t(this.fail(h&&h.dup()))})),o=s.manage(e.value),l=s.manage(this.getProp(o,"then"));this.callFunction(l,o,n,i).unwrap().dispose()})})}isEqual(r,e,t=N.IsStrictlyEqual){if(r===e)return!0;this.runtime.assertOwned(r),this.runtime.assertOwned(e);let s=this.ffi.QTS_IsEqual(this.ctx.value,r.value,e.value,t);if(s===-1)throw new le("WASM variant does not expose equality");return!!s}eq(r,e){return this.isEqual(r,e,N.IsStrictlyEqual)}sameValue(r,e){return this.isEqual(r,e,N.IsSameValue)}sameValueZero(r,e){return this.isEqual(r,e,N.IsSameValueZero)}getProp(r,e){this.runtime.assertOwned(r);let t;return typeof e=="number"&&e>=0?t=this.ffi.QTS_GetPropNumber(this.ctx.value,r.value,e):t=this.borrowPropertyKey(e).consume(s=>this.ffi.QTS_GetProp(this.ctx.value,r.value,s.value)),this.memory.heapValueHandle(t)}getLength(r){if(this.runtime.assertOwned(r),!(this.ffi.QTS_GetLength(this.ctx.value,this.uint32Out.value.ptr,r.value)<0))return this.uint32Out.value.typedArray[0]}getOwnPropertyNames(r,e={strings:!0,numbersAsStrings:!0}){this.runtime.assertOwned(r),r.value;let t=Je(e);if(t===0)throw new me("No options set, will return an empty array");return S.withScope(s=>{let n=s.manage(this.memory.newMutablePointerArray(1)),i=this.ffi.QTS_GetOwnPropertyNames(this.ctx.value,n.value.ptr,this.uint32Out.value.ptr,r.value,t);if(i)return this.fail(this.memory.heapValueHandle(i));let o=this.uint32Out.value.typedArray[0],l=n.value.typedArray[0],h=new Uint32Array(this.module.HEAP8.buffer,l,o),p=Array.from(h).map(d=>this.memory.heapValueHandle(d));return this.ffi.QTS_FreeVoidPointer(this.ctx.value,l),this.success(Oe(p))})}getIterator(r){let e=this._SymbolIterator??(this._SymbolIterator=this.memory.manage(this.getWellKnownSymbol("iterator")));return S.withScope(t=>{let s=t.manage(this.getProp(r,e)),n=this.callFunction(s,r);return n.error?n:this.success(new Ue(n.value,this))})}setProp(r,e,t){this.runtime.assertOwned(r),this.borrowPropertyKey(e).consume(s=>this.ffi.QTS_SetProp(this.ctx.value,r.value,s.value,t.value))}defineProp(r,e,t){this.runtime.assertOwned(r),S.withScope(s=>{let n=s.manage(this.borrowPropertyKey(e)),i=t.value||this.undefined,o=!!t.configurable,l=!!t.enumerable,h=!!t.value,p=t.get?s.manage(this.newFunction(t.get.name,t.get)):this.undefined,d=t.set?s.manage(this.newFunction(t.set.name,t.set)):this.undefined;this.ffi.QTS_DefineProp(this.ctx.value,r.value,n.value,i.value,p.value,d.value,o,l,h)})}callFunction(r,e,...t){this.runtime.assertOwned(r);let s,n=t[0];n===void 0||Array.isArray(n)?s=n??[]:s=t;let i=this.memory.toPointerArray(s).consume(l=>this.ffi.QTS_Call(this.ctx.value,r.value,e.value,s.length,l.value)),o=this.ffi.QTS_ResolveException(this.ctx.value,i);return o?(this.ffi.QTS_FreeValuePointer(this.ctx.value,i),this.fail(this.memory.heapValueHandle(o))):this.success(this.memory.heapValueHandle(i))}callMethod(r,e,t=[]){return this.getProp(r,e).consume(s=>this.callFunction(s,r,t))}evalCode(r,e="eval.js",t){let s=t===void 0?1:0,n=De(t),i=this.memory.newHeapCharPointer(r).consume(l=>this.ffi.QTS_Eval(this.ctx.value,l.value.ptr,l.value.strlen,e,s,n)),o=this.ffi.QTS_ResolveException(this.ctx.value,i);return o?(this.ffi.QTS_FreeValuePointer(this.ctx.value,i),this.fail(this.memory.heapValueHandle(o))):this.success(this.memory.heapValueHandle(i))}throw(r){return this.errorToHandle(r).consume(e=>this.ffi.QTS_Throw(this.ctx.value,e.value))}borrowPropertyKey(r){return typeof r=="number"?this.newNumber(r):typeof r=="string"?this.newString(r):new R(r.value,this.runtime)}getMemory(r){if(r===this.rt.value)return this.memory;throw new Error("Private API. Cannot get memory from a different runtime")}dump(r){this.runtime.assertOwned(r);let e=this.typeof(r);if(e==="string")return this.getString(r);if(e==="number")return this.getNumber(r);if(e==="bigint")return this.getBigInt(r);if(e==="undefined")return;if(e==="symbol")return this.getSymbol(r);let t=this.getPromiseState(r);if(t.type==="fulfilled"&&!t.notAPromise)return r.dispose(),{type:t.type,value:t.value.consume(this.dump)};if(t.type==="pending")return r.dispose(),{type:t.type};if(t.type==="rejected")return r.dispose(),{type:t.type,error:t.error.consume(this.dump)};let s=this.memory.consumeJSCharPointer(this.ffi.QTS_Dump(this.ctx.value,r.value));try{return JSON.parse(s)}catch{return s}}unwrapResult(r){if(r.error){let e="context"in r.error?r.error.context:this,t=r.error.consume(s=>this.dump(s));if(t&&typeof t=="object"&&typeof t.message=="string"){let{message:s,name:n,stack:i,...o}=t,l=new U(t,e);typeof n=="string"&&(l.name=t.name),l.message=s;let h=l.stack;throw typeof i=="string"&&(l.stack=`${n}: ${s}
${t.stack}Host: ${h}`),Object.assign(l,o),l}throw new U(t)}return r.value}[Symbol.for("nodejs.util.inspect.custom")](){return this.alive?`${this.constructor.name} { ctx: ${this.ctx.value} rt: ${this.rt.value} }`:`${this.constructor.name} { disposed }`}getFunction(r){let e=r>>8,t=this.fnMaps.get(e);if(t)return t.get(r)}setFunction(r,e){let t=r>>8,s=this.fnMaps.get(t);return s||(s=new Map,this.fnMaps.set(t,s)),s.set(r,e)}errorToHandle(r){return r instanceof E?r:this.newError(r)}encodeBinaryJSON(r){let e=this.ffi.QTS_bjson_encode(this.ctx.value,r.value);return this.memory.heapValueHandle(e)}decodeBinaryJSON(r){let e=this.ffi.QTS_bjson_decode(this.ctx.value,r.value);return this.memory.heapValueHandle(e)}success(r){return P.success(r)}fail(r){return P.fail(r,e=>this.unwrapResult(e))}},Ge=class extends T{constructor(r){var e;super(),this.scope=new S,this.contextMap=new Map,this._debugMode=!1,this.cToHostCallbacks={shouldInterrupt:t=>{if(t!==this.rt.value)throw new Error("QuickJSContext instance received C -> JS interrupt with mismatched rt");let s=this.interruptHandler;if(!s)throw new Error("QuickJSContext had no interrupt handler");return s(this)?1:0},loadModuleSource:te(this,function*(t,s,n,i){let o=this.moduleLoader;if(!o)throw new Error("Runtime has no module loader");if(s!==this.rt.value)throw new Error("Runtime pointer mismatch");let l=this.contextMap.get(n)??this.newContext({contextPointer:n});try{let h=yield*t(o(i,l));if(typeof h=="object"&&"error"in h&&h.error)throw this.debugLog("cToHostLoadModule: loader returned error",h.error),h.error;let p=typeof h=="string"?h:"value"in h?h.value:h;return this.memory.newHeapCharPointer(p).value.ptr}catch(h){return this.debugLog("cToHostLoadModule: caught error",h),l.throw(h),0}}),normalizeModule:te(this,function*(t,s,n,i,o){let l=this.moduleNormalizer;if(!l)throw new Error("Runtime has no module normalizer");if(s!==this.rt.value)throw new Error("Runtime pointer mismatch");let h=this.contextMap.get(n)??this.newContext({contextPointer:n});try{let p=yield*t(l(i,o,h));if(typeof p=="object"&&"error"in p&&p.error)throw this.debugLog("cToHostNormalizeModule: normalizer returned error",p.error),p.error;let d=typeof p=="string"?p:p.value;return h.getMemory(this.rt.value).newHeapCharPointer(d).value.ptr}catch(p){return this.debugLog("normalizeModule: caught error",p),h.throw(p),0}})},(e=r.ownedLifetimes)==null||e.forEach(t=>this.scope.manage(t)),this.module=r.module,this.memory=new ve(this.module),this.ffi=r.ffi,this.rt=r.rt,this.callbacks=r.callbacks,this.scope.manage(this.rt),this.callbacks.setRuntimeCallbacks(this.rt.value,this.cToHostCallbacks),this.executePendingJobs=this.executePendingJobs.bind(this)}get alive(){return this.scope.alive}dispose(){return this.scope.dispose()}newContext(r={}){let e=Be(r.intrinsics),t=new E(r.contextPointer||this.ffi.QTS_NewContext(this.rt.value,e),void 0,n=>{this.contextMap.delete(n),this.callbacks.deleteContext(n),this.ffi.QTS_FreeContext(n)}),s=new Ve({module:this.module,ctx:t,ffi:this.ffi,rt:this.rt,ownedLifetimes:r.ownedLifetimes,runtime:this,callbacks:this.callbacks});return this.contextMap.set(t.value,s),s}setModuleLoader(r,e){this.moduleLoader=r,this.moduleNormalizer=e,this.ffi.QTS_RuntimeEnableModuleLoader(this.rt.value,this.moduleNormalizer?1:0)}removeModuleLoader(){this.moduleLoader=void 0,this.ffi.QTS_RuntimeDisableModuleLoader(this.rt.value)}hasPendingJob(){return!!this.ffi.QTS_IsJobPending(this.rt.value)}setInterruptHandler(r){let e=this.interruptHandler;this.interruptHandler=r,e||this.ffi.QTS_RuntimeEnableInterruptHandler(this.rt.value)}removeInterruptHandler(){this.interruptHandler&&(this.ffi.QTS_RuntimeDisableInterruptHandler(this.rt.value),this.interruptHandler=void 0)}executePendingJobs(r=-1){let e=this.memory.newMutablePointerArray(1),t=this.ffi.QTS_ExecutePendingJob(this.rt.value,r??-1,e.value.ptr),s=e.value.typedArray[0];if(e.dispose(),s===0)return this.ffi.QTS_FreeValuePointerRuntime(this.rt.value,t),P.success(0);let n=this.contextMap.get(s)??this.newContext({contextPointer:s}),i=n.getMemory(this.rt.value).heapValueHandle(t);if(n.typeof(i)==="number"){let o=n.getNumber(i);return i.dispose(),P.success(o)}else{let o=Object.assign(i,{context:n});return P.fail(o,l=>n.unwrapResult(l))}}setMemoryLimit(r){if(r<0&&r!==-1)throw new Error("Cannot set memory limit to negative number. To unset, pass -1");this.ffi.QTS_RuntimeSetMemoryLimit(this.rt.value,r)}computeMemoryUsage(){let r=this.getSystemContext().getMemory(this.rt.value);return r.heapValueHandle(this.ffi.QTS_RuntimeComputeMemoryUsage(this.rt.value,r.ctx.value))}dumpMemoryUsage(){return this.memory.consumeHeapCharPointer(this.ffi.QTS_RuntimeDumpMemoryUsage(this.rt.value))}setMaxStackSize(r){if(r<0)throw new Error("Cannot set memory limit to negative number. To unset, pass 0.");this.ffi.QTS_RuntimeSetMaxStackSize(this.rt.value,r)}assertOwned(r){if(r.owner&&r.owner.rt!==this.rt)throw new oe(`Handle is not owned by this runtime: ${r.owner.rt.value} != ${this.rt.value}`)}setDebugMode(r){this._debugMode=r,this.ffi.DEBUG&&this.rt.alive&&this.ffi.QTS_SetDebugLogEnabled(this.rt.value,r?1:0)}isDebugMode(){return this._debugMode}debugLog(...r){this._debugMode&&console.log("quickjs-emscripten:",...r)}[Symbol.for("nodejs.util.inspect.custom")](){return this.alive?`${this.constructor.name} { rt: ${this.rt.value} }`:`${this.constructor.name} { disposed }`}getSystemContext(){return this.context||(this.context=this.scope.manage(this.newContext())),this.context}},Ke=class{constructor(r){this.callFunction=r.callFunction,this.shouldInterrupt=r.shouldInterrupt,this.loadModuleSource=r.loadModuleSource,this.normalizeModule=r.normalizeModule}},ge=class{constructor(r){this.contextCallbacks=new Map,this.runtimeCallbacks=new Map,this.suspendedCount=0,this.cToHostCallbacks=new Ke({callFunction:(e,t,s,n,i,o)=>this.handleAsyncify(e,()=>{try{let l=this.contextCallbacks.get(t);if(!l)throw new Error(`QuickJSContext(ctx = ${t}) not found for C function call "${o}"`);return l.callFunction(t,s,n,i,o)}catch(l){return console.error("[C to host error: returning null]",l),0}}),shouldInterrupt:(e,t)=>this.handleAsyncify(e,()=>{try{let s=this.runtimeCallbacks.get(t);if(!s)throw new Error(`QuickJSRuntime(rt = ${t}) not found for C interrupt`);return s.shouldInterrupt(t)}catch(s){return console.error("[C to host interrupt: returning error]",s),1}}),loadModuleSource:(e,t,s,n)=>this.handleAsyncify(e,()=>{try{let i=this.runtimeCallbacks.get(t);if(!i)throw new Error(`QuickJSRuntime(rt = ${t}) not found for C module loader`);let o=i.loadModuleSource;if(!o)throw new Error(`QuickJSRuntime(rt = ${t}) does not support module loading`);return o(t,s,n)}catch(i){return console.error("[C to host module loader error: returning null]",i),0}}),normalizeModule:(e,t,s,n,i)=>this.handleAsyncify(e,()=>{try{let o=this.runtimeCallbacks.get(t);if(!o)throw new Error(`QuickJSRuntime(rt = ${t}) not found for C module loader`);let l=o.normalizeModule;if(!l)throw new Error(`QuickJSRuntime(rt = ${t}) does not support module loading`);return l(t,s,n,i)}catch(o){return console.error("[C to host module loader error: returning null]",o),0}})}),this.module=r,this.module.callbacks=this.cToHostCallbacks}setRuntimeCallbacks(r,e){this.runtimeCallbacks.set(r,e)}deleteRuntime(r){this.runtimeCallbacks.delete(r)}setContextCallbacks(r,e){this.contextCallbacks.set(r,e)}deleteContext(r){this.contextCallbacks.delete(r)}handleAsyncify(r,e){if(r)return r.handleSleep(s=>{try{let n=e();if(!(n instanceof Promise)){I("asyncify.handleSleep: not suspending:",n),s(n);return}if(this.suspended)throw new ue(`Already suspended at: ${this.suspended.stack}
Attempted to suspend at:`);this.suspended=new ce(`(${this.suspendedCount++})`),I("asyncify.handleSleep: suspending:",this.suspended),n.then(i=>{this.suspended=void 0,I("asyncify.handleSleep: resolved:",i),s(i)},i=>{I("asyncify.handleSleep: rejected:",i),console.error("QuickJS: cannot handle error in suspended function",i),this.suspended=void 0})}catch(n){throw this.suspended=void 0,n}});let t=e();if(t instanceof Promise)throw new Error("Promise return value not supported in non-asyncify context.");return t}};function Ee(r,e){e.interruptHandler&&r.setInterruptHandler(e.interruptHandler),e.maxStackSizeBytes!==void 0&&r.setMaxStackSize(e.maxStackSizeBytes),e.memoryLimitBytes!==void 0&&r.setMemoryLimit(e.memoryLimitBytes)}function Se(r,e){e.moduleLoader&&r.setModuleLoader(e.moduleLoader),e.shouldInterrupt&&r.setInterruptHandler(e.shouldInterrupt),e.memoryLimitBytes!==void 0&&r.setMemoryLimit(e.memoryLimitBytes),e.maxStackSizeBytes!==void 0&&r.setMaxStackSize(e.maxStackSizeBytes)}var We=class{constructor(r,e){this.module=r,this.ffi=e,this.callbacks=new ge(r)}newRuntime(r={}){let e=new E(this.ffi.QTS_NewRuntime(),void 0,s=>{this.callbacks.deleteRuntime(s),this.ffi.QTS_FreeRuntime(s)}),t=new Ge({module:this.module,callbacks:this.callbacks,ffi:this.ffi,rt:e});return Ee(t,r),r.moduleLoader&&t.setModuleLoader(r.moduleLoader),t}newContext(r={}){let e=this.newRuntime(),t=e.newContext({...r,ownedLifetimes:He(e,r.ownedLifetimes)});return e.context=t,t}evalCode(r,e={}){return S.withScope(t=>{let s=t.manage(this.newContext());Se(s.runtime,e);let n=s.evalCode(r,"eval.js");if(e.memoryLimitBytes!==void 0&&s.runtime.setMemoryLimit(-1),n.error)throw s.dump(t.manage(n.error));return s.dump(t.manage(n.value))})}getWasmMemory(){var e,t,s,n;let r=(n=(s=(t=(e=this.module).quickjsEmscriptenInit)==null?void 0:t.call(e,()=>{}))==null?void 0:s.getWasmMemory)==null?void 0:n.call(s);if(!r)throw new Error("Variant does not support getting WebAssembly.Memory");return r}getFFI(){return this.ffi}};async function qe(r){let e=O(await r),[t,s,{QuickJSWASMModule:n}]=await Promise.all([e.importModuleLoader().then(O),e.importFFI(),H(()=>Promise.resolve().then(()=>ot),void 0).then(O)]),i=await t();i.type="sync";let o=new s(i);return new n(i,o)}function O(r){return r&&"default"in r&&r.default?r.default&&"default"in r.default&&r.default.default?r.default.default:r.default:r}function ze(r,e){return{...r,async importModuleLoader(){let t=O(await r.importModuleLoader());return async function(){var m;let s=e.emscriptenModule?{...e.emscriptenModule}:{},n=e.log??((...c)=>I("newVariant moduleLoader:",...c)),i=(c,y)=>(n(...c,y),y),o=c=>typeof c=="function"?c():c;(e.wasmLocation||e.wasmSourceMapLocation||e.locateFile)&&(s.locateFile=(c,y)=>{let g={fileName:c,relativeTo:y};if(c.endsWith(".wasm")&&e.wasmLocation!==void 0)return i(["locateFile .wasm: provide wasmLocation",g],e.wasmLocation);if(c.endsWith(".map")){if(e.wasmSourceMapLocation!==void 0)return i(["locateFile .map: provide wasmSourceMapLocation",g],e.wasmSourceMapLocation);if(e.wasmLocation&&!e.locateFile)return i(["locateFile .map: infer from wasmLocation",g],e.wasmLocation+".map")}return e.locateFile?i(["locateFile: use provided fn",g],e.locateFile(c,y)):i(["locateFile: unhandled, passthrough",g],c)}),e.wasmBinary&&(s.wasmBinary=await o(e.wasmBinary)),e.wasmMemory&&(s.wasmMemory=await o(e.wasmMemory));let l=e.wasmModule,h;l&&(s.instantiateWasm=async(c,y)=>{h??(h=Promise.resolve(o(l)));let g=await h;if(!g)throw new V(`options.wasmModule returned ${String(g)}`);let v=await WebAssembly.instantiate(g,c);return y(v),v.exports}),s.monitorRunDependencies=c=>{n("monitorRunDependencies:",c)},s.quickjsEmscriptenInit=()=>Ye(n);let p=t(s),d=(m=s.quickjsEmscriptenInit)==null?void 0:m.call(s,n);if(l&&(d!=null&&d.receiveWasmOffsetConverter)&&!d.existingWasmOffsetConverter){let c=await o(e.wasmBinary)??new ArrayBuffer(0);h??(h=Promise.resolve(o(l)));let y=await h;if(!y)throw new V(`options.wasmModule returned ${String(y)}`);d.receiveWasmOffsetConverter(c,y)}if(d!=null&&d.receiveSourceMapJSON){let c=await o(e.wasmSourceMapData);typeof c=="string"?d.receiveSourceMapJSON(JSON.parse(c)):c?d.receiveSourceMapJSON(c):d.receiveSourceMapJSON({version:3,names:[],sources:[],mappings:""})}return p}}}}function Ye(r){let e="mock called, emscripten module may not be initialized yet";return{mock:!0,removeRunDependency(t){r(`${e}: removeRunDependency called:`,t)},receiveSourceMapJSON(t){r(`${e}: receiveSourceMapJSON called:`,t)},WasmOffsetConverter:void 0,receiveWasmOffsetConverter(t,s){r(`${e}: receiveWasmOffsetConverter called:`,t,s)}}}var Ze={type:"sync",importFFI:()=>H(()=>import("./ffi-DlhRHxHv.js"),[]).then(r=>r.QuickJSFFI),importModuleLoader:()=>H(()=>import("./emscripten-module.browser-DS88wJvm.js"),[]).then(r=>r.default)},Xe=Ze;const et="/Verse/assets/emscripten-module-NWak2PoB.wasm",tt=ze(Xe,{wasmLocation:et});async function rt(){return await qe(tt)}self.MonacoEnvironment={getWorker(){return new Ae}};const _={characterState:{hp:45,maxHp:60,level:5,spellCastings:[{name:"Cleric",slots:[{level:1,current:3,max:4},{level:2,current:2,max:3},{level:3,current:1,max:2}],spells:[{name:"Cure Wounds",level:1,damage:"1d8"},{name:"Bless",level:1,damage:""},{name:"Spiritual Weapon",level:2,damage:"1d8+3"},{name:"Revivify",level:3,damage:""}]},{name:"Wizard",slots:[{level:1,current:4,max:4},{level:2,current:3,max:3}],spells:[{name:"Magic Missile",level:1,damage:"1d4+1"},{name:"Shield",level:1,damage:""},{name:"Misty Step",level:2,damage:""}]}]},casting:{name:"Cleric",slots:[{level:1,current:3,max:4},{level:2,current:2,max:3},{level:3,current:1,max:2}],spells:[{name:"Cure Wounds",level:1,damage:"1d8"},{name:"Bless",level:1,damage:""},{name:"Spiritual Weapon",level:2,damage:"1d8+3"},{name:"Revivify",level:3,damage:""}]},slot:{level:2,current:2,max:3}},we=[{title:"Type Declarations",desc:"Define custom types and interfaces",code:`// Define custom types
type SpellLevel = number
type DamageType = string | null

interface Spell {
  name: string,
  level: SpellLevel,
  damage: DamageType
}

// Use the types
const spell: Spell = casting.spells[0]
return spell`},{title:"Typed Variables",desc:"Variables with explicit type annotations",code:`// Variable with type annotation
const level: number = 2
const filtered: Spell[] = casting.spells.filter(s => s.level <= level)
return filtered`},{title:"Typed Functions",desc:"Functions with parameter and return types",code:`// Function with type annotations
fn getSpellsAtLevel(level: number) -> Spell[] {
  const spells: Spell[] = casting.spells.filter(s => s.level == level)
  return spells
}

return getSpellsAtLevel(2)`},{title:"Union Types",desc:"Handle multiple possible types",code:`// Function with union return type
fn findSpell(name: string) -> Spell | null {
  const found: Spell | null = casting.spells.find(s => s.name == name)
  return found
}

const result: Spell | null = findSpell("Fireball")
return result`},{title:"Filter Spells by Level",desc:"Returns spells at or below level 2",code:`// Filter spells by level
const filtered = casting.spells.filter(s => s.level <= 2)
return filtered`},{title:"Nested Context Access",desc:"Access parent scope variables",code:`// Get spells for current slot level
const spells = casting.spells.filter(s => s.level == slot.level)
return spells`},{title:"Conditional Returns",desc:"Different return types based on condition",code:`// Check if spell slots available
if slot.current <= 0 {
  return null
}

const available = casting.spells.filter(s => s.level == slot.level)
return available`},{title:"HP Calculation",desc:"Calculate HP percentage",code:`// Calculate HP percentage
const hpPercent = (characterState.hp / characterState.maxHp) * 100
return hpPercent`}],z=b.createObjectType("Spell",{name:u.string,level:u.number,damage:u.string}),Y=b.createObjectType("SpellSlot",{level:u.number,current:u.number,max:u.number}),Z=b.createObjectType("SpellCasting",{name:u.string,slots:b.createArrayType(Y),spells:b.createArrayType(z)}),be=b.createObjectType("CharacterState",{hp:u.number,maxHp:u.number,level:u.number,spellCastings:b.createArrayType(Z)});function w(r){const e=document.getElementById(r);if(!e)throw new Error(`Missing element #${r}`);return e}const Q=document.getElementById("globalsJson"),x=document.getElementById("globalGetName"),A=document.getElementById("globalSetName");Q&&(Q.value=JSON.stringify(_,null,2));x&&(x.value="getValue");A&&(A.value="setValue");const st=x?x.value:"getValue",nt=A?A.value:"setValue";let B=new b({characterState:be,casting:Z,slot:Y},{globalGet:st,globalSet:nt});B.registerType("spell",z);const ne=document.getElementById("applyGlobalsBtn");ne&&ne.addEventListener("click",()=>{try{if(Q){const t=JSON.parse(Q.value);Object.keys(_).forEach(s=>delete _[s]),Object.assign(_,t)}const r=x?x.value:"getValue",e=A?A.value:"setValue";B=new b({characterState:be,casting:Z,slot:Y},{globalGet:r,globalSet:e}),B.registerType("spell",z),X()}catch(r){const e=r instanceof Error?r.message:String(r);alert("Invalid globals JSON: "+e)}});f.register({id:"verse"});f.setMonarchTokensProvider("verse",{defaultToken:"invalid",keywords:["if","else","while","function","fn","return","let","const","for","break","continue","true","false","null"],typeKeywords:["number","string","bool","array","interface","void"],operators:["=",">","<","!","~","?",":","==","<=",">=","!=","&&","||","++","--","+","-","*","/","&","|","^","%","<<",">>",">>>","+=","-=","*=","/=","&=","|=","^=","%="],symbols:/[=><!~?:&|+\-*/^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,tokenizer:{root:[[/[a-z_$][\w$]*/,{cases:{"@typeKeywords":"type","@keywords":"keyword","@default":"identifier"}}],[/[A-Z][\w$]*/,"type.identifier"],{include:"@whitespace"},[/[{}()[\]]/,"@brackets"],[/[<>](?!@symbols)/,"@brackets"],[/@symbols/,{cases:{"@operators":"operator","@default":""}}],[/\d*\.\d+([eE][-+]?\d+)?/,"number.float"],[/0[xX][0-9a-fA-F]+/,"number.hex"],[/\d+/,"number"],[/[;,.]/,"delimiter"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/"/,{token:"string.quote",bracket:"@open",next:"@string"}],[/'[^\\']'/,"string"],[/(')(@escapes)(')/,["string","string.escape","string"]],[/'/,"string.invalid"]],comment:[[/[^/*]+/,"comment"],[/\/\*/,"comment","@push"],["\\*/","comment","@pop"],[/[/*]/,"comment"]],string:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,{token:"string.quote",bracket:"@close",next:"@pop"}]],whitespace:[[/[ \t\r\n]+/,"white"],[/\/\/.*$/,"comment"]]}});f.setLanguageConfiguration("verse",{comments:{lineComment:"//"},brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],folding:{markers:{start:new RegExp("^\\s*//\\s*#?region\\b"),end:new RegExp("^\\s*//\\s*#?endregion\\b")}}});f.registerCompletionItemProvider("verse",{provideCompletionItems:(r,e)=>{const t=r.getWordUntilPosition(e),s={startLineNumber:e.lineNumber,endLineNumber:e.lineNumber,startColumn:t.startColumn,endColumn:t.endColumn};return{suggestions:[{label:"fn",kind:f.CompletionItemKind.Keyword,insertText:"fn ${1:functionName}(${2:params}) -> ${3:ReturnType} {\n	$0\n}",insertTextRules:f.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Define a function",range:s},{label:"if",kind:f.CompletionItemKind.Keyword,insertText:`if (\${1:condition}) {
	$0
}`,insertTextRules:f.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"If statement",range:s},{label:"else",kind:f.CompletionItemKind.Keyword,insertText:`else {
	$0
}`,insertTextRules:f.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Else statement",range:s},{label:"while",kind:f.CompletionItemKind.Keyword,insertText:`while (\${1:condition}) {
	$0
}`,insertTextRules:f.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"While loop",range:s},{label:"const",kind:f.CompletionItemKind.Keyword,insertText:"const ${1:name}: ${2:type} = ${3:value}",insertTextRules:f.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Constant declaration",range:s},{label:"let",kind:f.CompletionItemKind.Keyword,insertText:"let ${1:name}: ${2:type} = ${3:value}",insertTextRules:f.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Variable declaration",range:s},{label:"return",kind:f.CompletionItemKind.Keyword,insertText:"return ${1:value}",insertTextRules:f.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Return statement",range:s},{label:"string",kind:f.CompletionItemKind.TypeParameter,insertText:"string",documentation:"String type",range:s},{label:"number",kind:f.CompletionItemKind.TypeParameter,insertText:"number",documentation:"Number type",range:s},{label:"bool",kind:f.CompletionItemKind.TypeParameter,insertText:"bool",documentation:"Boolean type",range:s},{label:"array",kind:f.CompletionItemKind.TypeParameter,insertText:"array",documentation:"Array type",range:s},{label:"null",kind:f.CompletionItemKind.Keyword,insertText:"null",documentation:"Null value",range:s},{label:"interface",kind:f.CompletionItemKind.Keyword,insertText:`interface \${1:Name} {
	$0
}`,insertTextRules:f.CompletionItemInsertTextRule.InsertAsSnippet,documentation:"Interface definition",range:s},{label:"true",kind:f.CompletionItemKind.Keyword,insertText:"true",documentation:"Boolean true",range:s},{label:"false",kind:f.CompletionItemKind.Keyword,insertText:"false",documentation:"Boolean false",range:s}]}}});f.registerHoverProvider("verse",{provideHover:(r,e)=>{const t=r.getWordAtPosition(e);if(!t)return null;const n={fn:"Define a function with optional parameters and return type",if:"Conditional statement",else:"Alternative branch for if statement",while:"Loop while condition is true",const:"Declare a constant (immutable) variable",let:"Declare a mutable variable",return:"Return a value from a function",string:"Text data type",number:"Numeric data type",bool:"Boolean data type (true/false)",array:"Collection data type",null:"Represents absence of value",interface:"Define a structural type"}[t.word];return n?{range:new xe(e.lineNumber,t.startColumn,e.lineNumber,t.endColumn),contents:[{value:`**${t.word}**`},{value:n}]}:null}});ae.defineTheme("verse-dark",{base:"vs-dark",inherit:!0,rules:[{token:"keyword",foreground:"C586C0",fontStyle:"bold"},{token:"type",foreground:"4EC9B0"},{token:"type.identifier",foreground:"4EC9B0"},{token:"identifier",foreground:"9CDCFE"},{token:"string",foreground:"CE9178"},{token:"number",foreground:"B5CEA8"},{token:"comment",foreground:"6A9955",fontStyle:"italic"},{token:"operator",foreground:"D4D4D4"}],colors:{"editor.background":"#1E1E1E"}});const it=w("editor"),L=ae.create(it,{value:we[0].code,language:"verse",theme:"verse-dark",automaticLayout:!0,fontSize:14,minimap:{enabled:!1},scrollBeyondLastLine:!1,lineNumbers:"on",roundedSelection:!1,padding:{top:10,bottom:10}});let F=null,ie;L.onDidChangeModelContent(()=>{clearTimeout(ie),ie=setTimeout(()=>{X()},500)});function X(){const r=L.getValue();try{const e=B.compile(r);F=e;const t=w("typeInfo"),s=w("compiledCode"),n=w("statusIndicator");e.success?(t.className="type-info success",t.innerHTML=`
        <div class="type-info-label">Return Type</div>
        <div class="type-info-value">${e.returnType}</div>
      `,s.textContent=e.code??"",n.innerHTML='<span class="status-indicator status-success"></span>'):(t.className="type-info error",t.innerHTML=`
        <div class="type-info-label">Compilation Error</div>
        <div class="type-info-value">${e.error}</div>
      `,s.textContent="// Error during compilation",n.innerHTML='<span class="status-indicator status-error"></span>')}catch(e){console.error("Compilation error:",e)}}w("runBtn").addEventListener("click",async()=>{if(!F||!F.success){alert("Fix compilation errors before running");return}const r=F;try{const e=await rt();S.withScope(t=>{const s=t.manage(e.newContext()),n=x&&x.value?x.value:"getValue",i=A&&A.value?A.value:"setValue",o=_,l=Object.keys(o).map(g=>`var ${g} = ${JSON.stringify(o[g])};`).join(`
`),h=`
function ${n}(path) {
  try { return eval(path); } catch(e) { return undefined; }
}

function ${i}(path, value) {
  try {
    // Assign using a Function so that 'value' is available in the assignment scope
    const fn = new Function('v', \`\${path} = v; return v;\`);
    return fn(value);
  } catch (e) { throw e; }
}
`,p=t.manage(s.unwrapResult(s.evalCode(`
            ${l}
            ${h}

            function main() {
              ${r.code}
            }

            main()
          `))),d=s.dump(p),m=w("executionResult"),c=w("resultValue");m.style.display="block",c.textContent=JSON.stringify(d,null,2);const y=w("consoleOutput");y.textContent=`Execution successful!

Result:
${JSON.stringify(d,null,2)}`})}catch(e){const t=e instanceof Error?e.message:String(e);alert("Execution error: "+t);const s=w("consoleOutput");s.textContent=`Error: ${t}`}});w("formatBtn").addEventListener("click",()=>{const e=L.getValue().trim();L.setValue(e)});const at=w("examples");we.forEach(r=>{const e=document.createElement("button");e.className="example-btn",e.innerHTML=`
    <div class="example-title">${r.title}</div>
    <div class="example-desc">${r.desc}</div>
  `,e.addEventListener("click",()=>{L.setValue(r.code)}),at.appendChild(e)});document.querySelectorAll(".tab").forEach(r=>{r.addEventListener("click",()=>{const e=r.dataset.tab;if(!e)return;document.querySelectorAll(".tab").forEach(s=>s.classList.remove("active")),r.classList.add("active"),document.querySelectorAll(".tab-content").forEach(s=>s.classList.remove("active"));const t=document.querySelector(`.tab-content[data-tab="${e}"]`);t&&t.classList.add("active")})});X();const ot=Object.freeze(Object.defineProperty({__proto__:null,QuickJSModuleCallbacks:ge,QuickJSWASMModule:We,applyBaseRuntimeOptions:Ee,applyModuleEvalRuntimeOptions:Se},Symbol.toStringTag,{value:"Module"}));
